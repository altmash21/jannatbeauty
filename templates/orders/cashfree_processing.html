{% extends 'base.html' %}
{% load static %}

{% block title %}Processing Payment...{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Verifying Your Payment</h4>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <h5>Order ID: {{ order_id }}</h5>
                        <p class="text-muted">Please wait while we confirm your payment with the bank...<br>
                        This usually takes a few seconds.</p>
                    </div>
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div id="status-message" class="mt-3 text-muted small"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Poll payment status as per Cashfree best practices
const orderId = "{{ order_id }}";
let pollAttempts = 0;
const maxPollAttempts = 15; // 15 seconds
const pollInterval = 1000; // 1 second

function checkPaymentStatus() {
    fetch(`/orders/cashfree/status/?order_id=${orderId}`)
        .then(response => response.json())
        .then(data => {
            console.log(`Poll attempt ${pollAttempts + 1}: Status = ${data.status}`);
            
            if (data.status === 'PAID') {
                // Payment successful - reload to trigger order creation
                window.location.href = `/orders/cashfree/return/?order_id=${orderId}`;
            } else if (data.status === 'FAILED' || data.status === 'CANCELLED') {
                // Payment failed
                window.location.href = '/orders/payment-failed/';
            } else if (pollAttempts < maxPollAttempts) {
                // Still pending - continue polling
                pollAttempts++;
                document.getElementById('status-message').textContent = 
                    `Checking payment status... (${pollAttempts}/${maxPollAttempts})`;
                setTimeout(checkPaymentStatus, pollInterval);
            } else {
                // Max attempts reached - treat as failure
                console.log('Max polling attempts reached, treating as failed payment');
                window.location.href = '/orders/payment-failed/';
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
            document.getElementById('status-message').innerHTML = 
                '<div class="alert alert-danger">Error verifying payment. Please refresh the page or contact support.</div>';
        });
}

// Start polling when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Starting payment verification for order:', orderId);
    checkPaymentStatus();
});
</script>
{% endblock %}
