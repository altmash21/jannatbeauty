
{% extends 'base_plain.html' %}
{% load static %}
{% block title %}Checkout{% endblock %}

{% block content %}
<section class="py-2">
    <style>
        /* Make checkout text colors darker for better readability */
        .billing-details label,
        .billing-details .form-label,
        .billing-details .form-check-label,
        .billing-details input,
        .billing-details .form-control {
            color: #222 !important;
        }
        .order-summary,
        .order-summary h4,
        .order-summary h5,
        .order-summary strong,
        .order-summary span,
        .order-summary .form-check-label,
        .order-summary .form-check-input {
            color: #222 !important;
        }
        .order-summary .text-primary {
            color: #176a3a !important;
        }
        .order-summary .text-muted {
            color: #555 !important;
        }
    </style>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                {% comment %} <h1 class="display-5">Checkout</h1> {% endcomment %}
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'store:home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'cart:cart_detail' %}">Cart</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </nav>
            </div>
        </div>
        <div class="row g-5">
            <div class="col-lg-7">
                <!-- Billing Details -->
                <div class="billing-details">
                    <h5 class="mb-4 text-uppercase">Billing Details</h5>
                    {% if messages %}
                    <div class="alert-container mb-3">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# Address selection dropdown for logged-in users with saved addresses #}
                    {% if user.is_authenticated and saved_addresses and saved_addresses|length > 0 %}
                    <div class="mb-3">
                        <label for="selectAddress" class="form-label">Choose a saved address</label>
                        <select id="selectAddress" class="form-select">
                            <option value="">-- Select an address --</option>
                            {% for address in saved_addresses %}
                            <option value="{{ address.id }}"
                                data-full_name="{{ address.full_name }}"
                                data-phone="{{ address.phone }}"
                                data-address_line1="{{ address.address_line1 }}"
                                data-address_line2="{{ address.address_line2 }}"
                                data-city="{{ address.city }}"
                                data-state="{{ address.state }}"
                                data-postal_code="{{ address.postal_code }}"
                                data-country="{{ address.country }}"
                                data-email="{{ user.email }}"
                            >
                                {{ address.full_name }}, {{ address.address_line1 }}{% if address.address_line2 %}, {{ address.address_line2 }}{% endif %}, {{ address.city }}, {{ address.state }} - {{ address.postal_code }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <form method="post" action="{% url 'orders:checkout' %}">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="firstName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="firstName" name="first_name" value="{{ initial_data.first_name|default_if_none:'' }}{% if initial_data.last_name %} {{ initial_data.last_name }}{% endif %}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone *</label>
                                <input type="tel" class="form-control" id="phone" name="phone" value="{{ initial_data.phone|default:'' }}" required>
                            </div>
                            <div class="col-12">
                                <label for="address" class="form-label">Street Address *</label>
                                <input type="text" class="form-control mb-2" id="address" name="address" value="{{ initial_data.address|default:'' }}" placeholder="House number and street name" required>
                                <input type="text" class="form-control" id="address2" name="address2" value="{{ initial_data.address2|default:'' }}" placeholder="Apartment, suite, unit, etc. (optional)">
                            </div>
                            <div class="col-md-6">
                                <label for="city" class="form-label">Town / City *</label>
                                <input type="text" class="form-control" id="city" name="city" value="{{ initial_data.city|default:'' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="state" class="form-label">State / Province *</label>
                                <input type="text" class="form-control" id="state" name="state" value="{{ initial_data.state|default:'' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="zip" class="form-label">ZIP Code *</label>
                                <input type="text" class="form-control" id="zip" name="zipcode" value="{{ initial_data.zipcode|default:'' }}" required>
                                <div id="pincode-result" class="small mt-1"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="country" class="form-label">Country *</label>
                                <input type="text" class="form-control" id="country" name="country" value="{{ initial_data.country|default:'India' }}" required>
                            </div>
                            <div class="col-12">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ initial_data.email|default:'' }}" required>
                            </div>
                            <div class="col-12">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="saveAddress" name="save_address">
                                    <label class="form-check-label" for="saveAddress">
                                        Save this address to my account
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Methods moved inside the form -->
                        <div class="payment-methods mt-4">
                            <h5 class="text-uppercase mb-3">Payment Method</h5>
                            <div class="form-check mb-3 p-3 border">
                                <input class="form-check-input" type="radio" name="payment" id="cashfree" value="cashfree">
                                <label class="form-check-label w-100" for="cashfree">
                                    <strong>Cashfree (UPI, Card, Netbanking)</strong>
                                    <p class="text-muted small mt-2 mb-0">Pay securely online using Cashfree.</p>
                                </label>
                            </div>
                            <div class="form-check mb-3 p-3 border">
                                <input class="form-check-input" type="radio" name="payment" id="cashOnDelivery" value="cod" checked>
                                <label class="form-check-label w-100" for="cashOnDelivery">
                                    <strong>Cash on Delivery</strong>
                                    <p class="text-muted small mt-2 mb-0">Pay with cash upon delivery.</p>
                                </label>
                            </div>
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I have read and agree to the website <a href="{% url 'store:about' %}" target="_blank">terms and conditions</a> *
                                </label>
                            </div>
                        </div>
                        
                        {% if payment_session_id %}
                            <!-- Payment will redirect to Cashfree -->
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                Complete Payment ₹{{ cart_total|floatformat:2 }}
                            </button>
                        {% else %}
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                Place Order
                            </button>
                        {% endif %}
                        </form>
                    </div>
                    <!-- Shipping Details, Order Notes, etc. can be added here as needed -->
            </div>
            <div class="col-lg-5">
                <div class="order-summary bg-light p-4">
                    <h4 class="text-uppercase mb-4">Cart Total</h4>
                    <div class="order-items">
                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <strong>Product</strong>
                            <strong>Subtotal</strong>
                        </div>
                        {% for item in cart %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ item.product.name }} × {{ item.quantity }}</span>
                            <span>₹{{ item.total_price|floatformat:2 }}</span>
                        </div>
                        {% endfor %}
                        <div class="d-flex justify-content-between mb-3 pb-3 border-top pt-3 mt-3">
                            <span>Price ({{ cart|length }} item{{ cart|length|pluralize }})</span>
                            <span class="fw-bold">₹{{ mrp_total|floatformat:2 }}</span>
                        </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Discount on MRP</span>
                                <span class="fw-bold text-success">-₹{{ discount|floatformat:2 }}</span>
                            </div>
                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                            <span>Convenience Fee</span>
                            <span class="fw-bold text-success">₹0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <strong class="text-uppercase">Total Amount</strong>
                            <strong class="text-primary fs-5">₹{{ cart_total|floatformat:2 }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% if payment_session_id %}
<!-- Cashfree Direct Payment Integration -->
<script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show loading state
    document.body.innerHTML = `
        <div class="container my-5">
            <div class="row justify-content-center">
                <div class="col-md-6 text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4>Redirecting to Payment Gateway...</h4>
                    <p class="text-muted">Please wait while we redirect you to the secure payment page.</p>
                </div>
            </div>
        </div>
    `;
    
    // Initialize Cashfree
    const cashfree = Cashfree({
        mode: "{{ cashfree_env }}" // "sandbox" or "production"
    });
    
    // Auto-trigger Cashfree payment for online payment
    console.log('Initializing Cashfree payment...');
    
    const checkoutOptions = {
        paymentSessionId: "{{ payment_session_id }}",
        returnUrl: "{{ return_url }}",
    };
    
    // Redirect to Cashfree payment gateway
    cashfree.checkout(checkoutOptions).then(function(result) {
        if (result.error) {
            console.error("Payment initialization failed:", result.error);
            alert("Payment initialization failed. Please try again.");
            window.location.href = "{% url 'orders:checkout' %}";
        }
        // User will be redirected to Cashfree payment page automatically
    }).catch(function(error) {
        console.error("Cashfree checkout error:", error);
        alert("Payment gateway error. Please try again.");
        window.location.href = "{% url 'orders:checkout' %}";
    });
});
</script>
{% endif %}

<script>
// Shiprocket pincode check
document.addEventListener('DOMContentLoaded', function() {
    var zipInput = document.getElementById('zip');
    var resultDiv = document.getElementById('pincode-result');
    if (zipInput) {
        zipInput.addEventListener('blur', function() {
            var pincode = zipInput.value;
            if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
                fetch('/orders/ajax/check-pincode/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value
                    },
                    body: JSON.stringify({pincode: pincode})
                })
                .then(response => response.json())
                .then(data => {
                    resultDiv.textContent = data.message;
                })
                .catch(() => { resultDiv.textContent = 'Could not check delivery.'; });
            } else {
                resultDiv.textContent = '';
            }
        });
    }
});
{% if payment_session_id %}
// Payment will redirect to Cashfree payment page
{% endif %}

// Address autofill from dropdown
document.addEventListener('DOMContentLoaded', function() {
    var select = document.getElementById('selectAddress');
    if (select) {
        select.addEventListener('change', function() {
            var selected = select.options[select.selectedIndex];
            if (selected.value) {
                document.getElementById('firstName').value = selected.getAttribute('data-full_name') || '';
                document.getElementById('phone').value = selected.getAttribute('data-phone') || '';
                document.getElementById('address').value = selected.getAttribute('data-address_line1') || '';
                document.getElementById('address2').value = selected.getAttribute('data-address_line2') || '';
                document.getElementById('city').value = selected.getAttribute('data-city') || '';
                document.getElementById('state').value = selected.getAttribute('data-state') || '';
                document.getElementById('zip').value = selected.getAttribute('data-postal_code') || '';
                document.getElementById('country').value = selected.getAttribute('data-country') || 'India';
                document.getElementById('email').value = selected.getAttribute('data-email') || '';
            }
        });
    }
});
// Handle payment method selection persistence
document.addEventListener('DOMContentLoaded', function() {
    // Get stored payment method from localStorage
    const storedPayment = localStorage.getItem('selectedPaymentMethod');
    if (storedPayment) {
        const paymentRadio = document.getElementById(storedPayment === 'cashfree' ? 'cashfree' : 'cashOnDelivery');
        if (paymentRadio) {
            paymentRadio.checked = true;
        }
    }
    
    // Store payment method when changed
    const paymentRadios = document.querySelectorAll('input[name="payment"]');
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            localStorage.setItem('selectedPaymentMethod', this.value);
            console.log('Payment method changed to:', this.value);
        });
    });
    
    // Clear stored payment method on successful form submission
    const form = document.querySelector('form[action*="checkout"]');
    if (form) {
        form.addEventListener('submit', function() {
            const selectedPayment = document.querySelector('input[name="payment"]:checked');
            if (selectedPayment) {
                console.log('Submitting form with payment method:', selectedPayment.value);
                // Don't clear localStorage here - let the backend handle the redirect
            }
        });
    }
});
</script>



<script>
// Auto-dismiss messages after 5 seconds and prevent accumulation on checkout page
document.addEventListener('DOMContentLoaded', function() {
    const messages = document.querySelectorAll('.alert');
    
    messages.forEach(function(message, index) {
        // Auto-dismiss after 5 seconds
        setTimeout(function() {
            if (message && message.parentElement) {
                message.style.transition = 'opacity 0.5s, transform 0.5s';
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(function() {
                    if (message.parentElement) {
                        message.remove();
                    }
                }, 500);
            }
        }, 5000 + (index * 200)); // Stagger messages slightly
        
        // Add click to dismiss functionality
        const closeBtn = message.querySelector('.btn-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                message.style.transition = 'opacity 0.5s, transform 0.5s';
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(function() {
                    if (message.parentElement) {
                        message.remove();
                    }
                }, 500);
            });
        }
    });
});
</script>

{% endblock %}
